# 見積書デモアプリ 要件定義書

## 1. プロジェクト概要

### 1.1 プロジェクト名
見積書デモアプリ

### 1.2 目的
見積書作成業務を効率化するためのWebアプリケーション。Excel/PDFファイルの解析、テンプレート機能、原価計算機能を備えた見積書作成支援システム。

### 1.3 対象ユーザー
- 見積書作成担当者
- 原価計算担当者
- 査定・承認者

### 1.4 開発環境
- フロントエンド: Next.js
- 言語: TypeScript
- UIフレームワーク: React

---

## 2. 機能要件

### 2.1 基本情報入力機能

#### 2.1.1 入力項目一覧

| 項目名 | 入力タイプ | 必須 | 説明 | バリデーション |
|-------|----------|------|------|--------------|
| 見積番号 | テキスト | ◯ | 例: D11800 | 必須入力チェック |
| 客先 | テキスト | ◯ | 顧客名 | 必須入力チェック |
| 向先 | テキスト | ◯ | 納入先 | 必須入力チェック |
| 機器名 | テキスト | ◯ | 製作する機器の名称 | 必須入力チェック |
| 製作数量 | 数値+単位選択 | ◯ | 台/個/式から選択可能 | 必須入力、数値チェック、単位選択必須 |
| 納期 | 日付 | ◯ | 納入予定日 | 必須入力、日付形式チェック |
| 機種 | プルダウン | ◯ | 機種を選択 | 必須選択チェック |
| 機器形状 | テキスト | ◯ | 機器の形状を記入 | 必須入力チェック |
| 重量 | 数値（kg） | ◯ | 総重量 | 必須入力、数値チェック、0以上 |

#### 2.1.2 機能詳細
- 入力値のリアルタイムバリデーション
- 必須項目未入力時のエラー表示
- 数値項目のフォーマット表示（カンマ区切り等）

#### 2.1.3 UI設計（基本情報入力画面ボックス）
- **レイアウト**: グリッドレイアウト（2列または3列）
- **入力ボックス**: 
  - テキスト入力: 標準的なテキスト入力フィールド
  - 数値入力: 数値専用入力フィールド（カンマ区切り表示対応）
  - 日付入力: 日付ピッカーコンポーネント
  - プルダウン: セレクトボックス
  - 単位選択: ラジオボタンまたはセレクトボックス
- **ラベル**: 各入力項目の左側にラベル表示
- **必須マーク**: 必須項目には「*」マークを表示
- **エラー表示**: バリデーションエラー時は入力欄下に赤色でエラーメッセージ表示
- **入力支援**: プレースホルダー表示、オートコンプリート（機種等）

---

### 2.2 ファイルアップロード機能

#### 2.2.1 対応ファイル形式
- **Excel形式**: `.xlsx`, `.xlsm`, `.xls`
- **PDF形式**: `.pdf`

#### 2.2.2 ファイルサイズ制限
- 単一ファイル: 最大10MB
- 複数ファイル合計: 最大30MB（推奨）

#### 2.2.3 解析モード

| モード | 説明 | 使用ケース |
|-------|------|-----------|
| 個別解析 | 1ファイルを個別に解析 | 単一ファイルからデータ抽出 |
| 2ファイル統合 | 2つのファイルを統合解析 | 複数ファイルのデータを統合 |
| 3ファイル統合 | 3つのファイルを統合解析 | 3ファイルのデータを統合 |
| 2ファイル+価格参考 | 2ファイル統合 + 固定価格参照 | 価格情報を参照しながら統合 |

#### 2.2.4 ファイル情報表示
- アップロードしたファイル数を表示
- 処理結果メッセージの表示
  - 成功: 緑色表示
  - エラー: 赤色表示
  - 情報: 青色表示
- ファイル名一覧表示
- ファイル削除機能

#### 2.2.5 UI設計（ファイルアップロードUI）
- **ファイル選択エリア**:
  - ドラッグ&ドロップエリア（枠線表示、ホバー時ハイライト）
  - 「ファイルを選択」ボタン（クリックでファイル選択ダイアログを開く）
  - 対応ファイル形式の表示（例: "対応形式: .xlsx, .xlsm, .xls, .pdf"）
  - ファイルサイズ制限の表示（例: "最大10MB"）
- **解析モード選択UI**:
  - ラジオボタンまたはタブ形式で解析モードを選択
    - 個別解析
    - 2ファイル統合
    - 3ファイル統合
    - 2ファイル+価格参考
- **ファイル一覧表示**:
  - アップロード済みファイルのリスト表示
  - 各ファイルに削除ボタン（×アイコン）
  - ファイル名、サイズ、ステータスを表示
  - 処理中はローディングインジケーター表示
- **統合・解析ボタンUI**:
  - 「ファイル統合」ボタン（複数ファイル選択時）
  - 「解析開始」ボタン（ファイル選択後）
  - ボタンの有効/無効状態管理
- **処理結果メッセージ表示エリア**:
  - 成功メッセージ: 緑色背景、チェックアイコン
  - エラーメッセージ: 赤色背景、警告アイコン
  - 情報メッセージ: 青色背景、情報アイコン
  - メッセージは自動で非表示（3秒後）または手動で閉じる

#### 2.2.6 エラーハンドリング
- ファイル形式不正時のエラー表示
- ファイルサイズ超過時のエラー表示
- 解析失敗時のエラーメッセージ表示

---

### 2.3 テンプレート機能

#### 2.3.1 テンプレート選択
- プルダウンメニューからテンプレートを選択
- テンプレート一覧の表示
- テンプレート名・説明の表示

#### 2.3.1.1 UI設計（テンプレート選択画面）
- **テンプレート選択UI**:
  - プルダウンメニュー（セレクトボックス）でテンプレートを選択
  - テンプレート一覧の表示（オプション: カード形式またはリスト形式）
  - 各テンプレートに以下を表示:
    - テンプレート名
    - 説明（あれば）
    - 作成日時
    - プレビュー（オプション）
- **テンプレート適用ボタン**:
  - 「テンプレート適用」ボタン（選択後有効化）
  - 適用中のローディング表示
  - 適用完了のトースト通知
- **テンプレート検索機能**（オプション）:
  - 検索ボックスでテンプレート名を検索
  - フィルタリング機能

#### 2.3.2 テンプレート適用処理
- 「テンプレート適用」ボタンで適用
- 選択したテンプレートのデータをテーブルに自動入力
- 適用時に全行の自動再計算を実行
- 適用完了メッセージを表示
- 既存データとの差分表示（オプション）

#### 2.3.3 テンプレート保存機能
- 現在のデータをテンプレートとして保存
- テンプレート名の入力
- テンプレート説明の入力（オプション）
- 保存確認ダイアログ

#### 2.3.4 テンプレート管理
- テンプレート一覧表示
- テンプレート削除機能
- テンプレート編集機能（オプション）

---

### 2.4 タブ切替機能

#### 2.4.1 タブ構成

| タブ名 | 機能概要 | アイコン |
|-------|---------|---------|
| 原価明細 | 部品・材料の詳細入力テーブル | リスト |
| 原価計算 | 各種原価の計算・表示 | 電卓 |
| 備考・補足 | 備考・査印・補足事項の入力 | メモ |

#### 2.4.2 タブ機能詳細
- タブクリックで切り替え
- アクティブタブの視覚的強調
- タブ間のデータ連携
- 未保存データの警告表示（オプション）

---

### 2.5 原価明細タブ

#### 2.5.1 テーブル列構成

| 列名 | 説明 | 編集可否 | データ型 | 備考 |
|-----|------|---------|---------|------|
| 型式 | 部品の型式 | ◯ | テキスト | - |
| 名称 | 部品の名称 | ◯ | テキスト | - |
| Part Type | 部品種別（自動設定） | × | プルダウン | 自動判定または手動設定 |
| 材質 | 材質（プルダウン候補あり） | ◯ | プルダウン | 候補: SUS304, SUS316, 炭素鋼, アルミ |
| 寸法入力 | 寸法情報（Part Type別入力フォーム） | ◯ | カスタム | DimensionInputコンポーネント |
| 数量 | 数量 | ◯ | 数値 | 0以上 |
| 重量 | 重量（自動計算） | × | 数値（kg） | 自動計算 |
| 単価 | 単価 | ◯ | 数値（円） | 0以上 |
| 価格 | 価格（自動計算）| × | 数値（円） | 単価 × 数量 × 重量（該当時） |
| 自動 | 自動計算フラグ | ◯ | チェックボックス | 自動計算の有効/無効 |
| 操作 | 行削除ボタン | - | ボタン | 行削除 |

#### 2.5.2 材質プルダウン候補
- SUS304
- SUS316
- 炭素鋼
- アルミ
- その他（フリーテキスト入力可）

#### 2.5.3 行操作機能
- **行追加**: テーブル末尾に新規行を追加
  - デフォルト値の設定
  - フォーカス自動移動
- **行削除**: 指定した行を削除
  - 削除確認ダイアログ（オプション）
  - 削除後の再計算
- **行更新**: 各セルの値を編集（リアルタイム反映）
  - 入力値のバリデーション
  - 変更時の自動再計算

#### 2.5.4 寸法入力コンポーネント
- Part Typeに応じた専用入力フォーム（`DimensionInput`コンポーネント）
- Part Type未設定時はフリーテキスト入力
- 寸法入力から重量への自動計算

#### 2.5.5 自動計算機能
- **価格計算**: 単価 × 数量（重量ベースの計算も考慮）
- **合計価格**: フッターに表示
- **重量計算**: 寸法情報から自動計算
- **再計算トリガー**: 単価・数量・寸法変更時

#### 2.5.6 凡例表示
- **自動入力行**: 黄色背景で表示
- **テンプレートとの差分**: 差分色で表示
- 凡例の説明表示

#### 2.5.7 テーブル機能
- 行の並び替え（ドラッグ&ドロップ、オプション）
- 列のソート機能（オプション）
- 列の表示/非表示切り替え（オプション）
- ページネーション（大量データ時）

---

### 2.6 原価計算タブ

#### 2.6.1 自動計算項目

| 項目名 | 計算方式 | 説明 | 単位 |
|-------|---------|------|------|
| 材料費 | 自動 | テーブルデータの価格合計 | 円 |
| 加工費 | 自動 | 重量と部品種類から計算 | 円 |
| 塗装費 | 自動 | 塗装面積から計算 | 円 |

#### 2.6.2 手動入力項目

| 項目名 | 必須 | 説明 | 単位 | バリデーション |
|-------|------|------|------|--------------|
| 外注検査費 | ◯ | 外注検査にかかる費用 | 円 | 必須、数値、0以上 |
| 輸送費 | ◯ | 輸送にかかる費用 | 円 | 必須、数値、0以上 |
| 工場検査費 | ◯ | 工場検査にかかる費用 | 円 | 必須、数値、0以上 |
| 設計費 | ◯ | 設計にかかる費用 | 円 | 必須、数値、0以上 |

#### 2.6.3 原価サマリー（自動計算）

| 項目名 | 計算方式 | 説明 | 単位 |
|-------|---------|------|------|
| 直接原価 | 総原価 × 0.7 | 直接原価の計算 | 円 |
| 製造原価 | 総原価 × 0.9 | 製造原価の計算 | 円 |
| 総原価 | 全項目の合計 | 総原価の計算 | 円 |

#### 2.6.4 塗装面積表示
- テーブルデータから自動計算
- 単位: m²
- リアルタイム更新

#### 2.6.5 計算ロジック詳細
- **材料費**: `SUM(テーブル各行の価格)`
- **加工費**: `f(総重量, 部品種類数)`
- **塗装費**: `g(塗装面積)`
- **再計算トリガー**: テーブルデータ変更時、手動入力項目変更時

#### 2.6.6 UI設計（原価計算タブ・入力ボックス）
- **自動計算項目表示エリア**:
  - 材料費、加工費、塗装費を読み取り専用の入力ボックスで表示
  - 背景色をグレーまたは薄い色で表示（編集不可を明示）
  - 数値はカンマ区切りで表示（例: 1,234,567円）
  - 計算中はローディングインジケーター表示
- **手動入力項目エリア**:
  - 外注検査費、輸送費、工場検査費、設計費の入力ボックス
  - 標準的な数値入力フィールド
  - 必須項目には「*」マーク
  - バリデーションエラー時は赤色枠線とエラーメッセージ
  - 単位（円）を右側に表示
- **原価サマリー表示エリア**:
  - 直接原価、製造原価、総原価を大きなフォントで強調表示
  - 読み取り専用の入力ボックスまたは専用の表示エリア
  - 総原価は特に目立つ色（例: 青色、太字）で表示
- **塗装面積表示**:
  - 塗装面積を数値+単位（m²）で表示
  - 読み取り専用の入力ボックス
- **計算ボタン**:
  - 「再計算」ボタン（手動で再計算を実行）
  - 計算中のローディング表示
- **レイアウト**:
  - セクションごとに区切り線で分割
  - 自動計算項目と手動入力項目を視覚的に区別
  - 原価サマリーは下部に配置し、目立つデザイン

---

### 2.7 備考・補足タブ

#### 2.7.1 備考入力
- 3行の備考入力フィールド
- テンプレートから選択可能なプルダウン
- 最大40文字制限
- 文字数カウント表示

#### 2.7.2 見積査印情報

| 項目名 | 入力タイプ | 必須 | 説明 | バリデーション |
|-------|----------|------|------|--------------|
| 査定者 | テキスト | ◯ | 査定者名 | 必須入力 |
| 査定日 | 日付 | ◯ | 査定日 | 必須入力、日付形式 |
| 承認者 | テキスト | ◯ | 承認者名 | 必須入力 |
| 承認日 | 日付 | ◯ | 承認日 | 必須入力、日付形式、査定日以降 |

#### 2.7.2.1 UI設計（査印の入力ボックス）
- **査印情報入力エリア**:
  - 査定者、査定日、承認者、承認日を入力するテキスト/日付入力ボックス
  - グリッドレイアウト（2列×2行）
  - 必須項目には「*」マーク
  - 日付入力は日付ピッカーコンポーネント
  - バリデーションエラー時は赤色枠線とエラーメッセージ
- **下部査印欄表示エリア**:
  - 最終承認者欄: テキスト入力ボックス
  - 査印1〜4欄: 4つのテキスト入力ボックス（横並びまたは2×2グリッド）
  - 担当者欄: テキスト入力ボックス
  - 各欄は枠線で囲まれた入力ボックス
  - 査印欄は印鑑をイメージしたデザイン（オプション）

#### 2.7.3 補足事項入力

| カテゴリ | 入力欄数 | 文字制限 | 必須 |
|---------|---------|---------|------|
| 材料費 | 2行 | 最大60文字/行 | × |
| 内作加工費 | 2行 | 最大60文字/行 | × |
| 外注加工・塗装費・外注検査・運送費 | 2行 | 最大60文字/行 | × |

#### 2.7.4 機能詳細
- 文字数カウント表示
- 入力値のリアルタイムバリデーション
- テンプレートからの自動入力（オプション）

---

### 2.8 出力機能

#### 2.8.1 PDF出力
- テーブルデータと原価計算結果をPDF形式で出力
- ファイル名: `見積書_{見積番号}_{日付}.pdf`
- 日付形式: `YYYYMMDD`
- LibreOffice未インストール時はExcel形式で出力
- 出力前の確認ダイアログ

#### 2.8.2 Excel出力
- テーブルデータと原価計算結果をExcel形式で出力
- ファイル名: `見積書_{見積番号}_{日付}.xlsx`
- 日付形式: `YYYYMMDD`
- 出力前の確認ダイアログ

#### 2.8.3 出力データ
- 空行を除外してエクスポート
- 基本情報（projectInfo）を含む
- 原価計算結果（costCalculation）を含む
- 査印情報（approvalInfo）を含む
- 備考・補足事項を含む

#### 2.8.4 出力レイアウト
- 見積書フォーマットに準拠
- ヘッダー情報（見積番号、日付等）
- 基本情報セクション
- 原価明細テーブル
- 原価計算サマリー
- 備考・補足セクション
- 査印欄

---

### 2.9 下部アクションエリア

#### 2.9.1 アクションボタン

| ボタン名 | 機能 | アイコン | 状態 |
|---------|------|---------|------|
| 計算 | 原価を再計算 | 電卓 | 常時有効 |
| 保存 | データを保存 | 保存 | 変更時有効 |
| PDF出力 | PDF形式で出力 | PDF | データ入力時有効 |
| Excel出力 | Excel形式で出力 | Excel | データ入力時有効 |

#### 2.9.2 査印欄

| 項目名 | 説明 |
|-------|------|
| 最終承認者欄 | 最終承認者名 |
| 査印1〜4欄 | 査印者名（4名まで） |
| 担当者欄 | 担当者名 |

#### 2.9.3 機能詳細
- ボタンの有効/無効状態管理
- 保存成功/失敗メッセージ表示
- 出力進行状況表示（オプション）

---

### 2.10 ヘッダーアクション

#### 2.10.1 アクションボタン

| ボタン名 | 機能 | アイコン | 確認ダイアログ |
|---------|------|---------|--------------|
| トップに戻る | トップページへ遷移 | ホーム | 未保存時表示 |
| 既設データ検索 | 過去データの検索 | 検索 | × |
| テンプレート保存 | 現在のデータをテンプレートとして保存 | 保存 | × |

#### 2.10.2 機能詳細
- 未保存データがある場合の警告表示
- 検索機能の実装（オプション）
- テンプレート保存時の入力フォーム表示

#### 2.10.3 UI設計（ヘッダーアクションボタン）
- **ヘッダーエリア**:
  - 画面最上部に固定表示
  - 背景色を設定して他のエリアと区別
- **トップに戻るボタン**:
  - 左側に配置
  - ホームアイコン + 「トップに戻る」テキスト
  - 未保存データがある場合は確認ダイアログ表示
- **既設データ検索ボタン**:
  - 中央または右側に配置
  - 検索アイコン + 「既設データ検索」テキスト
  - クリックで検索モーダルまたは検索画面を表示
- **テンプレート保存ボタン**:
  - 右側に配置
  - 保存アイコン + 「テンプレート保存」テキスト
  - クリックでテンプレート名入力モーダルを表示
- **ボタンスタイル**:
  - 統一されたボタンデザイン
  - ホバー時の視覚的フィードバック
  - アイコンとテキストの組み合わせ

---

## 3. データ構造

### 3.1 基本情報（ProjectInfo）

```typescript
interface ProjectInfo {
  estimateNumber: string;      // 見積番号
  customer: string;             // 客先
  deliveryDestination: string;  // 向先
  equipmentName: string;        // 機器名
  productionQuantity: number;   // 製作数量
  productionUnit: string;       // 単位（台/個/式）
  deliveryDate: Date;          // 納期
  model: string;               // 機種
  equipmentShape: string;      // 機器形状
  weight: number;              // 重量（kg）
}
```

### 3.2 テーブル行データ（EstimateTableRow）

```typescript
interface EstimateTableRow {
  id: string;                  // 行ID
  modelNumber: string;         // 型式
  name: string;                // 名称
  partType: string;            // Part Type
  material: string;            // 材質
  dimensions: DimensionData;  // 寸法情報
  quantity: number;            // 数量
  weight: number;              // 重量（自動計算）
  unitPrice: number;           // 単価
  price: number;               // 価格（自動計算）
  isAuto: boolean;             // 自動計算フラグ
  isAutoInput: boolean;        // 自動入力行フラグ
  isTemplateDiff: boolean;     // テンプレート差分フラグ
}
```

### 3.3 寸法データ（DimensionData）

```typescript
interface DimensionData {
  partType: string;            // Part Type
  // Part Type別の寸法データ
  // 例: { length?: number, width?: number, height?: number, ... }
  [key: string]: any;
}
```

### 3.4 原価計算データ（CostCalculation）

```typescript
interface CostCalculation {
  materialCost: number;        // 材料費（自動）
  processingCost: number;      // 加工費（自動）
  paintingCost: number;        // 塗装費（自動）
  externalInspectionCost: number; // 外注検査費（手動）
  transportationCost: number;   // 輸送費（手動）
  factoryInspectionCost: number; // 工場検査費（手動）
  designCost: number;          // 設計費（手動）
  directCost: number;          // 直接原価（自動）
  manufacturingCost: number;   // 製造原価（自動）
  totalCost: number;           // 総原価（自動）
  paintingArea: number;        // 塗装面積（m²）
}
```

### 3.5 査印情報（ApprovalInfo）

```typescript
interface ApprovalInfo {
  assessor: string;            // 査定者
  assessmentDate: Date;        // 査定日
  approver: string;            // 承認者
  approvalDate: Date;          // 承認日
  finalApprover: string;       // 最終承認者
  seal1: string;              // 査印1
  seal2: string;              // 査印2
  seal3: string;              // 査印3
  seal4: string;              // 査印4
  personInCharge: string;      // 担当者
}
```

### 3.6 備考・補足データ

```typescript
interface RemarksData {
  remarks: string[];           // 備考（3行）
  materialCostNotes: string[]; // 材料費補足（2行）
  internalProcessingNotes: string[]; // 内作加工費補足（2行）
  externalProcessingNotes: string[]; // 外注加工等補足（2行）
}
```

### 3.7 テンプレートデータ（Template）

```typescript
interface Template {
  id: string;                  // テンプレートID
  name: string;                // テンプレート名
  description?: string;        // 説明
  projectInfo?: ProjectInfo;   // 基本情報
  tableData: EstimateTableRow[]; // テーブルデータ
  costCalculation?: CostCalculation; // 原価計算データ
  remarksData?: RemarksData;   // 備考・補足データ
  createdAt: Date;            // 作成日時
  updatedAt: Date;            // 更新日時
}
```

### 3.8 ファイルデータ（FileData）

```typescript
interface FileData {
  id: string;                  // ファイルID
  name: string;                // ファイル名
  type: string;                // ファイルタイプ
  size: number;                // ファイルサイズ（bytes）
  uploadedAt: Date;            // アップロード日時
  status: 'pending' | 'processing' | 'completed' | 'error';
  message?: string;            // 処理メッセージ
}
```

---

## 4. 状態管理

### 4.1 管理する状態

| 状態名 | 型 | 用途 | 初期値 |
|-------|-----|------|--------|
| projectInfo | ProjectInfo | 基本情報 | 空オブジェクト |
| tableData | EstimateTableRow[] | テーブルデータ | 空配列 |
| templateData | Template \| null | 適用中テンプレート | null |
| uploadedFiles | FileData[] | アップロードファイル | 空配列 |
| activeTab | string | アクティブタブ | '原価明細' |
| costCalculation | CostCalculation | 原価計算結果 | デフォルト値 |
| templates | Template[] | テンプレート一覧 | 空配列 |
| selectedTemplateId | string | 選択中テンプレートID | '' |
| uploadMessage | object \| null | アップロードメッセージ | null |
| approvalInfo | ApprovalInfo | 査印情報 | 空オブジェクト |
| remarksData | RemarksData | 備考・補足データ | 空オブジェクト |
| isDirty | boolean | 未保存フラグ | false |

### 4.2 状態更新フロー
- ユーザー入力 → 状態更新 → UI反映
- テンプレート適用 → 状態更新 → 再計算 → UI反映
- ファイルアップロード → 解析 → 状態更新 → UI反映

---

## 5. 自動計算トリガー

### 5.1 材料費・加工費・塗装費
- **トリガー**: `tableData`の変更時
- **計算内容**: 
  - 材料費 = テーブル各行の価格合計
  - 加工費 = f(総重量, 部品種類数)
  - 塗装費 = g(塗装面積)

### 5.2 原価サマリー
- **トリガー**: 各原価項目の変更時
- **計算内容**:
  - 直接原価 = 総原価 × 0.7
  - 製造原価 = 総原価 × 0.9
  - 総原価 = 全項目の合計

### 5.3 テーブル行の価格・重量
- **トリガー**: 単価・数量・寸法の変更時
- **計算内容**:
  - 重量 = 寸法情報から計算
  - 価格 = 単価 × 数量 × 重量（該当時）

---

## 6. 使用コンポーネント

### 6.1 カスタムコンポーネント

| コンポーネント | 用途 | Props |
|---------------|------|-------|
| DimensionInput | 寸法入力フォーム（Part Type別） | partType, value, onChange |
| EstimateTable | 原価明細テーブル | data, onUpdate, onAdd, onRemove |
| CostCalculationForm | 原価計算フォーム | data, onChange |
| RemarksForm | 備考・補足フォーム | data, onChange |
| FileUpload | ファイルアップロード | onUpload, maxSize, acceptedTypes |
| TemplateSelector | テンプレート選択 | templates, onSelect, onSave |

### 6.2 Next.jsコンポーネント

| コンポーネント | 用途 |
|---------------|------|
| Link | ページ遷移 |

---

## 7. 使用ユーティリティ関数

### 7.1 テンプレート関連

| 関数名 | 用途 | 引数 | 戻り値 |
|-------|------|------|--------|
| convertTemplateToTableRows | テンプレートをテーブル行に変換 | template: Template | EstimateTableRow[] |
| saveTemplate | テンプレートを保存 | template: Template | Promise<void> |
| loadTemplates | テンプレート一覧を取得 | - | Promise<Template[]> |
| deleteTemplate | テンプレートを削除 | id: string | Promise<void> |

### 7.2 テーブル操作

| 関数名 | 用途 | 引数 | 戻り値 |
|-------|------|------|--------|
| recalculateAll | 全行の再計算 | rows: EstimateTableRow[] | EstimateTableRow[] |
| addTableRow | 行追加 | rows: EstimateTableRow[] | EstimateTableRow[] |
| removeTableRow | 行削除 | rows: EstimateTableRow[], id: string | EstimateTableRow[] |
| updateTableRow | 行更新 | rows: EstimateTableRow[], id: string, data: Partial<EstimateTableRow> | EstimateTableRow[] |

### 7.3 原価計算

| 関数名 | 用途 | 引数 | 戻り値 |
|-------|------|------|--------|
| calculateTotalProcessingCost | 総加工費計算 | rows: EstimateTableRow[] | number |
| calculateTotalPaintingCost | 総塗装費計算 | rows: EstimateTableRow[] | number |
| calculateTotalPaintingArea | 総塗装面積計算 | rows: EstimateTableRow[] | number |
| calculateMaterialCost | 材料費計算 | rows: EstimateTableRow[] | number |
| calculateDirectCost | 直接原価計算 | totalCost: number | number |
| calculateManufacturingCost | 製造原価計算 | totalCost: number | number |

### 7.4 ファイル処理

| 関数名 | 用途 | 引数 | 戻り値 |
|-------|------|------|--------|
| parseExcelFile | Excelファイル解析 | file: File, mode: string | Promise<EstimateTableRow[]> |
| parsePdfFile | PDFファイル解析 | file: File, mode: string | Promise<EstimateTableRow[]> |
| mergeFiles | ファイル統合 | files: File[], mode: string | Promise<EstimateTableRow[]> |

### 7.5 出力処理

| 関数名 | 用途 | 引数 | 戻り値 |
|-------|------|------|--------|
| exportToPdf | PDF出力 | data: ExportData | Promise<void> |
| exportToExcel | Excel出力 | data: ExportData | Promise<void> |
| formatExportData | 出力データ整形 | projectInfo, tableData, costCalculation, ... | ExportData |

### 7.6 バリデーション

| 関数名 | 用途 | 引数 | 戻り値 |
|-------|------|------|--------|
| validateProjectInfo | 基本情報バリデーション | info: ProjectInfo | ValidationResult |
| validateTableRow | テーブル行バリデーション | row: EstimateTableRow | ValidationResult |
| validateCostCalculation | 原価計算バリデーション | calc: CostCalculation | ValidationResult |

---

## 8. 非機能要件

### 8.1 パフォーマンス
- テーブル行数1000行まで快適に動作
- ファイルアップロード処理: 10MBファイルを30秒以内に処理
- 画面遷移: 1秒以内
- 自動計算: リアルタイム（100ms以内）

### 8.2 ユーザビリティ
- 直感的なUI/UX
- エラーメッセージの明確な表示
- 操作ガイダンスの表示
- キーボードショートカット対応（オプション）

### 8.3 セキュリティ
- ファイルアップロード時のウイルススキャン（オプション）
- 入力値のサニタイズ
- XSS対策
- CSRF対策

### 8.4 互換性
- ブラウザ: Chrome最新版、Edge最新版、Firefox最新版
- レスポンシブデザイン: デスクトップ優先、タブレット対応（オプション）

### 8.5 データ永続化
- ローカルストレージまたはIndexedDBに保存
- 自動保存機能（オプション）
- データエクスポート/インポート機能

---

## 9. 制約事項

### 9.1 技術的制約
- Next.jsフレームワークを使用
- TypeScriptで実装
- クライアントサイドでの処理を基本とする
- PDF出力はLibreOfficeに依存（未インストール時はExcel出力）

### 9.2 業務的制約
- ファイルサイズ: 10MB以下
- 対応ファイル形式: Excel, PDFのみ
- テンプレート数: 制限なし（推奨: 100個以下）

### 9.3 運用制約
- データはローカルに保存（サーバー不要）
- バックアップはユーザー側で実施

---

## 10. 画面遷移図

```
トップページ
  ↓
見積書作成画面
  ├─ 基本情報入力
  ├─ ファイルアップロード
  ├─ テンプレート選択
  ├─ 原価明細タブ
  ├─ 原価計算タブ
  └─ 備考・補足タブ
  ↓
出力（PDF/Excel）
```

---

## 11. エラーハンドリング

### 11.1 エラー種別

| エラー種別 | 発生ケース | 対応方法 |
|----------|----------|---------|
| バリデーションエラー | 必須項目未入力、形式不正 | エラーメッセージ表示、入力欄をハイライト |
| ファイルエラー | ファイル形式不正、サイズ超過 | エラーメッセージ表示、ファイル削除 |
| 解析エラー | ファイル解析失敗 | エラーメッセージ表示、再試行可能 |
| 計算エラー | 計算処理失敗 | エラーメッセージ表示、デフォルト値設定 |
| 保存エラー | データ保存失敗 | エラーメッセージ表示、再試行可能 |
| 出力エラー | PDF/Excel出力失敗 | エラーメッセージ表示、代替手段提示 |

### 11.2 エラーメッセージ表示
- トースト通知またはインライン表示
- エラー詳細の表示（オプション）
- エラー解決方法の提示（オプション）

---

## 12. テスト要件

### 12.1 単体テスト
- ユーティリティ関数のテスト
- 計算ロジックのテスト
- バリデーション関数のテスト

### 12.2 結合テスト
- コンポーネント間の連携テスト
- 状態管理のテスト
- ファイル処理のテスト

### 12.3 E2Eテスト
- 見積書作成フローのテスト
- ファイルアップロードフローのテスト
- 出力フローのテスト

---

## 13. 開発スケジュール（参考）

### 13.1 フェーズ1: 基本機能
- 基本情報入力
- テーブル表示・編集
- 基本的な計算機能

### 13.2 フェーズ2: 高度な機能
- ファイルアップロード・解析
- テンプレート機能
- 原価計算機能

### 13.3 フェーズ3: 出力機能
- PDF出力
- Excel出力
- データ保存

### 13.4 フェーズ4: 改善・最適化
- UI/UX改善
- パフォーマンス最適化
- テスト実装

---

## 14. 用語集

| 用語 | 説明 |
|-----|------|
| 見積番号 | 見積書を識別するための一意の番号 |
| 客先 | 見積書を提出する顧客 |
| 向先 | 製品を納入する先 |
| Part Type | 部品の種類（板金、機械加工等） |
| 直接原価 | 製品に直接かかる原価 |
| 製造原価 | 製造にかかる全ての原価 |
| 総原価 | 見積書に記載する全ての原価の合計 |

---

## 15. 改訂履歴

| 版 | 日付 | 改訂内容 | 改訂者 |
|---|------|---------|--------|
| 1.0 | YYYY-MM-DD | 初版作成 | - |

---

## 16. フロントエンドUI設計詳細

### 16.1 画面レイアウト構成

#### 16.1.1 全体レイアウト
```
┌─────────────────────────────────────────┐
│ ヘッダー（戻る、検索、テンプレート保存） │
├─────────────────────────────────────────┤
│ 基本情報入力エリア（入力ボックス群）     │
├─────────────────────────────────────────┤
│ ファイルアップロードUI                   │
├─────────────────────────────────────────┤
│ テンプレート選択UI                       │
├─────────────────────────────────────────┤
│ タブ（原価明細/原価計算/備考・補足）     │
│ ┌─────────────────────────────────────┐ │
│ │ タブコンテンツエリア                 │ │
│ │ - 原価明細: テーブル                 │ │
│ │ - 原価計算: 入力ボックス群           │ │
│ │ - 備考・補足: 入力ボックス群         │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│ 下部アクションエリア（計算、保存、出力） │
│ 査印欄（最終承認者、査印1-4、担当者）   │
└─────────────────────────────────────────┘
```

### 16.2 UIコンポーネント詳細仕様

#### 16.2.1 基本情報入力画面ボックス
- **配置**: 画面中央上部
- **レイアウト**: グリッドレイアウト（レスポンシブ対応）
  - デスクトップ: 3列
  - タブレット: 2列
  - モバイル: 1列
- **入力ボックス仕様**:
  - 高さ: 40px
  - 幅: 100%（親要素に依存）
  - パディング: 8px 12px
  - ボーダー: 1px solid #ccc
  - ボーダーラディウス: 4px
  - フォントサイズ: 14px
  - フォーカス時: ボーダー色を青色に変更、シャドウ表示
- **ラベル仕様**:
  - フォントサイズ: 14px
  - フォントウェイト: 500
  - 必須マーク: 赤色「*」
  - ラベルと入力ボックスの間隔: 8px
- **エラー表示**:
  - エラー時: ボーダー色を赤色に変更
  - エラーメッセージ: 入力ボックス下に12px下に配置、赤色テキスト、フォントサイズ12px

#### 16.2.2 ヘッダーアクションボタンUI
- **配置**: 画面最上部、固定表示
- **高さ**: 60px
- **背景色**: #f5f5f5
- **ボタン配置**: 横並び、右寄せ
- **ボタン仕様**:
  - 高さ: 36px
  - パディング: 8px 16px
  - ボーダーラディウス: 4px
  - アイコンサイズ: 20px
  - アイコンとテキストの間隔: 8px
  - ホバー時: 背景色変更、カーソルポインター
  - ボタン間隔: 12px

#### 16.2.3 ファイルアップロードUI
- **ファイル選択エリア**:
  - 高さ: 200px
  - ボーダー: 2px dashed #ccc
  - ボーダーラディウス: 8px
  - 背景色: #fafafa
  - ホバー時: ボーダー色を青色に変更、背景色を#f0f0f0に変更
  - ドラッグオーバー時: ボーダー色を緑色に変更
- **ファイル選択ボタン**:
  - プライマリボタンスタイル
  - 中央配置
  - アイコン: アップロードアイコン
- **解析モード選択UI**:
  - ラジオボタングループまたはタブ形式
  - 各モードに説明テキストを表示
- **ファイル一覧表示**:
  - リスト形式またはカード形式
  - 各ファイル項目:
    - ファイル名（太字）
    - ファイルサイズ（グレー）
    - ステータスバッジ（成功/エラー/処理中）
    - 削除ボタン（×アイコン、右側配置）
- **統合・解析ボタン**:
  - 「ファイル統合」ボタン: セカンダリボタンスタイル
  - 「解析開始」ボタン: プライマリボタンスタイル
  - 無効時: グレーアウト、クリック不可

#### 16.2.4 テンプレート選択画面UI
- **テンプレート選択プルダウン**:
  - 標準的なセレクトボックス
  - 幅: 300px
  - プレースホルダー: "テンプレートを選択してください"
- **テンプレート一覧表示**（オプション）:
  - カード形式またはリスト形式
  - 各カード:
    - テンプレート名（太字、16px）
    - 説明（グレー、12px）
    - 作成日時（グレー、12px）
    - 選択ボタンまたはクリックで選択
- **テンプレート適用ボタン**:
  - プライマリボタンスタイル
  - 選択後のみ有効化
  - 適用中はローディング表示

#### 16.2.5 原価計算タブ・入力ボックスUI
- **自動計算項目エリア**:
  - 背景色: #f9f9f9（読み取り専用を明示）
  - 入力ボックス: グレー背景、カーソル: not-allowed
  - 数値表示: 右寄せ、カンマ区切り
  - 単位表示: 右側に「円」を表示
- **手動入力項目エリア**:
  - 標準的な入力ボックス
  - 数値入力: 右寄せ、カンマ区切り表示
  - 単位表示: 右側に「円」を表示
  - 必須項目には「*」マーク
- **原価サマリー表示エリア**:
  - 背景色: #e3f2fd（薄い青色）
  - パディング: 16px
  - ボーダーラディウス: 8px
  - 総原価:
    - フォントサイズ: 24px
    - フォントウェイト: bold
    - 色: #1976d2（青色）
- **計算ボタン**:
  - プライマリボタンスタイル
  - アイコン: 電卓アイコン

#### 16.2.6 査印の入力ボックスUI
- **査印情報入力エリア**:
  - グリッドレイアウト: 2列×2行
  - 各入力ボックス: 標準的なテキスト/日付入力
  - 必須項目には「*」マーク
- **下部査印欄**:
  - 最終承認者欄: 単独の入力ボックス
  - 査印1〜4欄: 4つの入力ボックスを横並びまたは2×2グリッド
  - 担当者欄: 単独の入力ボックス
  - 各欄は枠線で囲まれた入力ボックス
  - 査印欄は正方形または円形の枠（印鑑をイメージ）

### 16.3 UIデザイン原則

#### 16.3.1 カラースキーム
- **プライマリカラー**: #1976d2（青色）
- **セカンダリカラー**: #424242（グレー）
- **成功色**: #4caf50（緑色）
- **エラー色**: #f44336（赤色）
- **警告色**: #ff9800（オレンジ色）
- **情報色**: #2196f3（ライトブルー）
- **背景色**: #ffffff（白）
- **グレー背景**: #f5f5f5

#### 16.3.2 タイポグラフィ
- **見出し**: 18px-24px、太字
- **本文**: 14px
- **補助テキスト**: 12px
- **フォントファミリー**: システムフォント（-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto等）

#### 16.3.3 スペーシング
- **基本単位**: 4px
- **要素間隔**: 8px, 12px, 16px, 24px
- **セクション間隔**: 24px-32px

#### 16.3.4 ボタンスタイル
- **プライマリボタン**: 
  - 背景色: プライマリカラー
  - テキスト色: 白色
  - ホバー時: 背景色を濃く
- **セカンダリボタン**:
  - 背景色: 透明
  - ボーダー: 1px solid プライマリカラー
  - テキスト色: プライマリカラー
  - ホバー時: 背景色を薄く
- **無効ボタン**:
  - 背景色: #e0e0e0
  - テキスト色: #9e9e9e
  - カーソル: not-allowed

#### 16.3.5 入力ボックススタイル
- **通常状態**:
  - ボーダー: 1px solid #ccc
  - 背景色: #ffffff
- **フォーカス状態**:
  - ボーダー: 2px solid プライマリカラー
  - シャドウ: 0 0 0 3px rgba(25, 118, 210, 0.1)
- **エラー状態**:
  - ボーダー: 2px solid エラー色
  - 背景色: #ffebee（薄い赤色）

#### 16.3.6 レスポンシブデザイン
- **デスクトップ**: 1200px以上
- **タブレット**: 768px-1199px
- **モバイル**: 767px以下
- グリッドレイアウトは画面サイズに応じて列数を調整

### 16.4 アクセシビリティ
- キーボードナビゲーション対応
- スクリーンリーダー対応（aria-label等）
- コントラスト比: WCAG AA準拠（4.5:1以上）
- フォーカスインジケーターの明確な表示

---

## 17. 承認

| 役割 | 氏名 | 承認日 | 承認印 |
|-----|------|--------|--------|
| 作成者 | - | - | - |
| レビュー者 | - | - | - |
| 承認者 | - | - | - |


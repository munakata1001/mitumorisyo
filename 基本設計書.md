# 見積書デモアプリ 基本設計書

## 1. ドキュメント情報

### 1.1 ドキュメント情報
- **ドキュメント名**: 基本設計書
- **バージョン**: 1.0
- **作成日**: YYYY-MM-DD
- **作成者**: -
- **関連ドキュメント**: 要件定義書

### 1.2 改訂履歴

| 版 | 日付 | 改訂内容 | 改訂者 |
|---|------|---------|--------|
| 1.0 | YYYY-MM-DD | 初版作成 | - |

---

## 2. システム概要

### 2.1 システム構成

```
┌─────────────────────────────────────────┐
│         ブラウザ（クライアント）         │
│  ┌───────────────────────────────────┐  │
│  │      Next.js アプリケーション      │  │
│  │  ┌─────────────────────────────┐  │  │
│  │  │   React コンポーネント      │  │  │
│  │  └─────────────────────────────┘  │  │
│  │  ┌─────────────────────────────┐  │  │
│  │  │   状態管理（React Context/   │  │  │
│  │  │   Zustand/Recoil等）         │  │  │
│  │  └─────────────────────────────┘  │  │
│  │  ┌─────────────────────────────┐  │  │
│  │  │   ユーティリティ関数         │  │  │
│  │  └─────────────────────────────┘  │  │
│  └───────────────────────────────────┘  │
│  ┌───────────────────────────────────┐  │
│  │   ローカルストレージ/IndexedDB    │  │
│  │   - テンプレートデータ            │  │
│  │   - 見積書データ                  │  │
│  └───────────────────────────────────┘  │
│  ┌───────────────────────────────────┐  │
│  │   ファイル処理ライブラリ           │  │
│  │   - Excel.js (Excel解析)          │  │
│  │   - pdf-lib (PDF解析)             │  │
│  └───────────────────────────────────┘  │
│  ┌───────────────────────────────────┐  │
│  │   出力ライブラリ                   │  │
│  │   - jsPDF (PDF出力)               │  │
│  │   - ExcelJS (Excel出力)           │  │
│  └───────────────────────────────────┘  │
└─────────────────────────────────────────┘
```

### 2.2 システム特性
- **アーキテクチャ**: クライアントサイドアプリケーション（SPA）
- **データ永続化**: ローカルストレージ/IndexedDB
- **サーバー**: 不要（完全クライアントサイド）
- **オフライン対応**: 可能（データはローカルに保存）

---

## 3. 技術スタック

### 3.1 フロントエンド

| 技術 | バージョン | 用途 |
|-----|----------|------|
| Next.js | 14.x | フレームワーク |
| React | 18.x | UIライブラリ |
| TypeScript | 5.x | 言語 |
| Tailwind CSS | 3.x | CSSフレームワーク（推奨） |
| Zustand | 4.x | 状態管理（推奨） |

### 3.2 ライブラリ

| ライブラリ | 用途 |
|----------|------|
| ExcelJS | Excelファイルの読み書き |
| pdf-lib | PDFファイルの読み書き |
| jsPDF | PDF生成 |
| date-fns | 日付処理 |
| react-hook-form | フォーム管理 |
| zod | バリデーション |

### 3.3 開発ツール

| ツール | 用途 |
|-------|------|
| ESLint | コード品質チェック |
| Prettier | コードフォーマット |
| Jest | 単体テスト |
| React Testing Library | コンポーネントテスト |

---

## 4. ディレクトリ構成

```
見積書デモアプリ/
├── app/                          # Next.js App Router
│   ├── layout.tsx               # ルートレイアウト
│   ├── page.tsx                 # トップページ
│   └── estimate/                # 見積書作成ページ
│       └── page.tsx
├── components/                   # Reactコンポーネント
│   ├── common/                  # 共通コンポーネント
│   │   ├── Button.tsx
│   │   ├── Input.tsx
│   │   ├── Select.tsx
│   │   └── DatePicker.tsx
│   ├── estimate/                # 見積書関連コンポーネント
│   │   ├── ProjectInfoForm.tsx  # 基本情報入力
│   │   ├── FileUpload.tsx       # ファイルアップロード
│   │   ├── TemplateSelector.tsx # テンプレート選択
│   │   ├── EstimateTable.tsx    # 原価明細テーブル
│   │   ├── CostCalculationForm.tsx # 原価計算フォーム
│   │   ├── RemarksForm.tsx       # 備考・補足フォーム
│   │   └── DimensionInput.tsx   # 寸法入力
│   └── layout/                  # レイアウトコンポーネント
│       ├── Header.tsx           # ヘッダー
│       └── Footer.tsx           # フッター
├── lib/                          # ライブラリ・ユーティリティ
│   ├── storage/                 # ストレージ関連
│   │   ├── localStorage.ts     # ローカルストレージ操作
│   │   └── indexedDB.ts        # IndexedDB操作
│   ├── file/                    # ファイル処理
│   │   ├── excelParser.ts      # Excel解析
│   │   ├── pdfParser.ts        # PDF解析
│   │   └── fileMerger.ts       # ファイル統合
│   ├── calculation/             # 計算ロジック
│   │   ├── materialCost.ts     # 材料費計算
│   │   ├── processingCost.ts   # 加工費計算
│   │   ├── paintingCost.ts     # 塗装費計算
│   │   └── costSummary.ts      # 原価サマリー計算
│   ├── export/                  # 出力処理
│   │   ├── pdfExporter.ts      # PDF出力
│   │   └── excelExporter.ts   # Excel出力
│   └── validation/              # バリデーション
│       ├── projectInfo.ts      # 基本情報バリデーション
│       ├── tableRow.ts         # テーブル行バリデーション
│       └── costCalculation.ts  # 原価計算バリデーション
├── store/                        # 状態管理
│   ├── estimateStore.ts         # 見積書データストア
│   ├── templateStore.ts         # テンプレートストア
│   └── uiStore.ts               # UI状態ストア
├── types/                        # TypeScript型定義
│   ├── estimate.ts              # 見積書関連型
│   ├── template.ts             # テンプレート関連型
│   └── file.ts                  # ファイル関連型
├── hooks/                        # カスタムフック
│   ├── useEstimate.ts           # 見積書操作フック
│   ├── useTemplate.ts           # テンプレート操作フック
│   └── useFileUpload.ts         # ファイルアップロードフック
├── utils/                        # ユーティリティ関数
│   ├── format.ts                # フォーマット関数
│   ├── date.ts                  # 日付処理関数
│   └── number.ts                # 数値処理関数
├── styles/                       # スタイル
│   └── globals.css               # グローバルスタイル
├── public/                       # 静的ファイル
│   └── images/                  # 画像ファイル
├── tests/                        # テストファイル
│   ├── unit/                    # 単体テスト
│   ├── integration/            # 結合テスト
│   └── e2e/                     # E2Eテスト
├── package.json
├── tsconfig.json
├── next.config.js
└── README.md
```

---

## 5. データモデル設計

### 5.1 基本情報（ProjectInfo）

```typescript
interface ProjectInfo {
  estimateNumber: string;        // 見積番号
  customer: string;               // 客先
  deliveryDestination: string;   // 向先
  equipmentName: string;         // 機器名
  productionQuantity: number;     // 製作数量
  productionUnit: '台' | '個' | '式'; // 単位
  deliveryDate: Date;            // 納期
  model: string;                 // 機種
  equipmentShape: string;        // 機器形状
  weight: number;                // 重量（kg）
}
```

### 5.2 テーブル行データ（EstimateTableRow）

```typescript
interface EstimateTableRow {
  id: string;                    // 行ID（UUID）
  modelNumber: string;            // 型式
  name: string;                  // 名称
  partType: string;              // Part Type
  material: string;              // 材質
  dimensions: DimensionData;     // 寸法情報
  quantity: number;              // 数量
  weight: number;                // 重量（自動計算、kg）
  unitPrice: number;             // 単価（円）
  price: number;                 // 価格（自動計算、円）
  isAuto: boolean;               // 自動計算フラグ
  isAutoInput: boolean;          // 自動入力行フラグ
  isTemplateDiff: boolean;       // テンプレート差分フラグ
  createdAt?: Date;              // 作成日時
  updatedAt?: Date;              // 更新日時
}
```

### 5.3 寸法データ（DimensionData）

```typescript
interface DimensionData {
  partType: string;
  // Part Type別の寸法データ
  length?: number;               // 長さ（mm）
  width?: number;                // 幅（mm）
  height?: number;              // 高さ（mm）
  thickness?: number;           // 厚さ（mm）
  diameter?: number;            // 直径（mm）
  radius?: number;              // 半径（mm）
  custom?: string;              // カスタム寸法（テキスト）
  [key: string]: any;           // その他の寸法データ
}
```

### 5.4 原価計算データ（CostCalculation）

```typescript
interface CostCalculation {
  // 自動計算項目
  materialCost: number;          // 材料費（円）
  processingCost: number;        // 加工費（円）
  paintingCost: number;         // 塗装費（円）
  
  // 手動入力項目
  externalInspectionCost: number; // 外注検査費（円）
  transportationCost: number;    // 輸送費（円）
  factoryInspectionCost: number;  // 工場検査費（円）
  designCost: number;            // 設計費（円）
  
  // 原価サマリー（自動計算）
  directCost: number;           // 直接原価（円）
  manufacturingCost: number;     // 製造原価（円）
  totalCost: number;            // 総原価（円）
  
  // その他
  paintingArea: number;         // 塗装面積（m²）
}
```

### 5.5 査印情報（ApprovalInfo）

```typescript
interface ApprovalInfo {
  assessor: string;             // 査定者
  assessmentDate: Date;         // 査定日
  approver: string;             // 承認者
  approvalDate: Date;          // 承認日
  finalApprover: string;       // 最終承認者
  seal1: string;               // 査印1
  seal2: string;               // 査印2
  seal3: string;               // 査印3
  seal4: string;               // 査印4
  personInCharge: string;      // 担当者
}
```

### 5.6 備考・補足データ（RemarksData）

```typescript
interface RemarksData {
  remarks: [string, string, string]; // 備考（3行、最大40文字/行）
  materialCostNotes: [string, string]; // 材料費補足（2行、最大60文字/行）
  internalProcessingNotes: [string, string]; // 内作加工費補足（2行、最大60文字/行）
  externalProcessingNotes: [string, string]; // 外注加工等補足（2行、最大60文字/行）
}
```

### 5.7 テンプレートデータ（Template）

```typescript
interface Template {
  id: string;                   // テンプレートID（UUID）
  name: string;                 // テンプレート名
  description?: string;         // 説明
  projectInfo?: ProjectInfo;   // 基本情報
  tableData: EstimateTableRow[]; // テーブルデータ
  costCalculation?: CostCalculation; // 原価計算データ
  remarksData?: RemarksData;    // 備考・補足データ
  approvalInfo?: ApprovalInfo;  // 査印情報
  createdAt: Date;             // 作成日時
  updatedAt: Date;             // 更新日時
}
```

### 5.8 見積書データ（Estimate）

```typescript
interface Estimate {
  id: string;                   // 見積書ID（UUID）
  projectInfo: ProjectInfo;     // 基本情報
  tableData: EstimateTableRow[]; // テーブルデータ
  costCalculation: CostCalculation; // 原価計算データ
  remarksData: RemarksData;     // 備考・補足データ
  approvalInfo: ApprovalInfo;   // 査印情報
  templateId?: string;          // 使用テンプレートID
  createdAt: Date;             // 作成日時
  updatedAt: Date;             // 更新日時
}
```

### 5.9 ファイルデータ（FileData）

```typescript
interface FileData {
  id: string;                   // ファイルID（UUID）
  name: string;                 // ファイル名
  type: 'excel' | 'pdf';       // ファイルタイプ
  size: number;                // ファイルサイズ（bytes）
  file: File;                   // Fileオブジェクト
  uploadedAt: Date;            // アップロード日時
  status: 'pending' | 'processing' | 'completed' | 'error';
  message?: string;            // 処理メッセージ
  parsedData?: EstimateTableRow[]; // 解析結果データ
}
```

---

## 6. 状態管理設計

### 6.1 ストア構成

#### 6.1.1 見積書ストア（estimateStore）

```typescript
interface EstimateStore {
  // 状態
  projectInfo: ProjectInfo;
  tableData: EstimateTableRow[];
  costCalculation: CostCalculation;
  remarksData: RemarksData;
  approvalInfo: ApprovalInfo;
  activeTab: '原価明細' | '原価計算' | '備考・補足';
  isDirty: boolean;
  
  // アクション
  setProjectInfo: (info: ProjectInfo) => void;
  setTableData: (data: EstimateTableRow[]) => void;
  addTableRow: () => void;
  removeTableRow: (id: string) => void;
  updateTableRow: (id: string, data: Partial<EstimateTableRow>) => void;
  setCostCalculation: (calc: CostCalculation) => void;
  setRemarksData: (data: RemarksData) => void;
  setApprovalInfo: (info: ApprovalInfo) => void;
  setActiveTab: (tab: string) => void;
  recalculateAll: () => void;
  reset: () => void;
  save: () => Promise<void>;
  load: (id: string) => Promise<void>;
}
```

#### 6.1.2 テンプレートストア（templateStore）

```typescript
interface TemplateStore {
  // 状態
  templates: Template[];
  selectedTemplateId: string | null;
  templateData: Template | null;
  
  // アクション
  loadTemplates: () => Promise<void>;
  saveTemplate: (template: Omit<Template, 'id' | 'createdAt' | 'updatedAt'>) => Promise<string>;
  deleteTemplate: (id: string) => Promise<void>;
  selectTemplate: (id: string) => void;
  applyTemplate: (template: Template) => void;
}
```

#### 6.1.3 UIストア（uiStore）

```typescript
interface UIStore {
  // 状態
  uploadMessage: { type: 'success' | 'error' | 'info'; message: string } | null;
  isLoading: boolean;
  uploadMode: '個別解析' | '2ファイル統合' | '3ファイル統合' | '2ファイル+価格参考';
  
  // アクション
  setUploadMessage: (message: { type: string; message: string } | null) => void;
  setLoading: (loading: boolean) => void;
  setUploadMode: (mode: string) => void;
}
```

### 6.2 状態更新フロー

```
ユーザー入力
  ↓
アクション発火
  ↓
ストア更新
  ↓
自動計算トリガー（該当時）
  ↓
UI再レンダリング
```

---

## 7. コンポーネント設計

### 7.1 コンポーネント階層

```
App
├── Layout
│   ├── Header
│   │   ├── BackButton
│   │   ├── SearchButton
│   │   └── SaveTemplateButton
│   └── Footer
├── EstimatePage
│   ├── ProjectInfoForm
│   │   ├── TextInput
│   │   ├── NumberInput
│   │   ├── DatePicker
│   │   └── Select
│   ├── FileUpload
│   │   ├── FileDropZone
│   │   ├── FileList
│   │   ├── ModeSelector
│   │   └── ParseButton
│   ├── TemplateSelector
│   │   ├── TemplateSelect
│   │   └── ApplyButton
│   ├── TabNavigation
│   │   ├── TabButton
│   │   └── TabContent
│   ├── EstimateTable (原価明細タブ)
│   │   ├── TableHeader
│   │   ├── TableRow
│   │   │   ├── DimensionInput
│   │   │   └── DeleteButton
│   │   ├── TableFooter
│   │   └── AddRowButton
│   ├── CostCalculationForm (原価計算タブ)
│   │   ├── AutoCalculatedField
│   │   ├── ManualInputField
│   │   └── CostSummary
│   ├── RemarksForm (備考・補足タブ)
│   │   ├── RemarksInput
│   │   ├── ApprovalInfoForm
│   │   └── SupplementaryNotes
│   └── ActionArea
│       ├── CalculateButton
│       ├── SaveButton
│       ├── ExportPdfButton
│       ├── ExportExcelButton
│       └── ApprovalSection
```

### 7.2 主要コンポーネント仕様

#### 7.2.1 ProjectInfoForm

```typescript
interface ProjectInfoFormProps {
  projectInfo: ProjectInfo;
  onChange: (info: ProjectInfo) => void;
  errors?: Record<string, string>;
}

// 機能
// - 基本情報の入力
// - リアルタイムバリデーション
// - エラー表示
```

#### 7.2.2 FileUpload

```typescript
interface FileUploadProps {
  onUpload: (files: File[], mode: string) => Promise<void>;
  maxSize: number; // 10MB
  acceptedTypes: string[]; // ['.xlsx', '.xlsm', '.xls', '.pdf']
}

// 機能
// - ドラッグ&ドロップ対応
// - ファイル選択
// - 解析モード選択
// - ファイル一覧表示
// - ファイル削除
```

#### 7.2.3 EstimateTable

```typescript
interface EstimateTableProps {
  data: EstimateTableRow[];
  onAdd: () => void;
  onRemove: (id: string) => void;
  onUpdate: (id: string, data: Partial<EstimateTableRow>) => void;
}

// 機能
// - テーブル表示
// - 行追加・削除
// - セル編集
// - 自動計算
// - 凡例表示
```

#### 7.2.4 DimensionInput

```typescript
interface DimensionInputProps {
  partType: string;
  value: DimensionData;
  onChange: (data: DimensionData) => void;
}

// 機能
// - Part Type別の寸法入力フォーム
// - 寸法から重量への自動計算
```

#### 7.2.5 CostCalculationForm

```typescript
interface CostCalculationFormProps {
  costCalculation: CostCalculation;
  onChange: (calc: CostCalculation) => void;
  tableData: EstimateTableRow[];
}

// 機能
// - 自動計算項目の表示
// - 手動入力項目の入力
// - 原価サマリーの表示
// - リアルタイム再計算
```

---

## 8. 画面遷移設計

### 8.1 画面遷移図

```
トップページ (/)
  ↓ [新規作成]
見積書作成ページ (/estimate)
  ├─ [戻る] → トップページ
  ├─ [データ検索] → 検索モーダル
  │   └─ [選択] → 見積書作成ページ（データ読み込み）
  └─ [テンプレート保存] → 保存モーダル
      └─ [保存] → 見積書作成ページ（継続）
```

### 8.2 ルーティング設計

```typescript
// app/page.tsx - トップページ
// app/estimate/page.tsx - 見積書作成ページ
// app/estimate/[id]/page.tsx - 既存見積書編集（オプション）
```

---

## 9. ファイル処理設計

### 9.1 Excel解析処理

```typescript
// lib/file/excelParser.ts

interface ParseOptions {
  mode: '個別解析' | '2ファイル統合' | '3ファイル統合' | '2ファイル+価格参考';
  priceReference?: File; // 価格参考ファイル（該当時）
}

async function parseExcelFile(
  file: File,
  options: ParseOptions
): Promise<EstimateTableRow[]> {
  // 1. Excelファイルを読み込み
  // 2. シートを解析
  // 3. データを抽出
  // 4. EstimateTableRow形式に変換
  // 5. 返却
}
```

### 9.2 PDF解析処理

```typescript
// lib/file/pdfParser.ts

async function parsePdfFile(
  file: File,
  options: ParseOptions
): Promise<EstimateTableRow[]> {
  // 1. PDFファイルを読み込み
  // 2. テキストを抽出
  // 3. 表データを解析
  // 4. EstimateTableRow形式に変換
  // 5. 返却
}
```

### 9.3 ファイル統合処理

```typescript
// lib/file/fileMerger.ts

async function mergeFiles(
  files: File[],
  mode: string
): Promise<EstimateTableRow[]> {
  // 1. 各ファイルを解析
  // 2. データを統合（重複除去、マージ）
  // 3. 統合データを返却
}
```

---

## 10. 計算ロジック設計

### 10.1 材料費計算

```typescript
// lib/calculation/materialCost.ts

function calculateMaterialCost(
  tableData: EstimateTableRow[]
): number {
  return tableData.reduce((sum, row) => {
    return sum + (row.price || 0);
  }, 0);
}
```

### 10.2 加工費計算

```typescript
// lib/calculation/processingCost.ts

function calculateProcessingCost(
  tableData: EstimateTableRow[]
): number {
  const totalWeight = tableData.reduce((sum, row) => sum + row.weight, 0);
  const partTypeCount = new Set(tableData.map(row => row.partType)).size;
  
  // 計算式: f(総重量, 部品種類数)
  // 例: totalWeight * 1000 + partTypeCount * 5000
  return totalWeight * 1000 + partTypeCount * 5000;
}
```

### 10.3 塗装費計算

```typescript
// lib/calculation/paintingCost.ts

function calculatePaintingCost(
  paintingArea: number
): number {
  // 計算式: g(塗装面積)
  // 例: paintingArea * 5000
  return paintingArea * 5000;
}

function calculatePaintingArea(
  tableData: EstimateTableRow[]
): number {
  // テーブルデータから塗装面積を計算
  // Part Typeに応じた面積計算ロジック
  return tableData.reduce((sum, row) => {
    // 寸法データから面積を計算
    return sum + calculateRowArea(row);
  }, 0);
}
```

### 10.4 原価サマリー計算

```typescript
// lib/calculation/costSummary.ts

function calculateCostSummary(
  costCalculation: CostCalculation
): {
  directCost: number;
  manufacturingCost: number;
  totalCost: number;
} {
  const totalCost = 
    costCalculation.materialCost +
    costCalculation.processingCost +
    costCalculation.paintingCost +
    costCalculation.externalInspectionCost +
    costCalculation.transportationCost +
    costCalculation.factoryInspectionCost +
    costCalculation.designCost;
  
  return {
    directCost: totalCost * 0.7,
    manufacturingCost: totalCost * 0.9,
    totalCost: totalCost
  };
}
```

### 10.5 重量計算

```typescript
// lib/calculation/weight.ts

function calculateWeight(
  dimensions: DimensionData,
  material: string,
  partType: string
): number {
  // Part Typeと材質に応じた重量計算
  // 例: 板金の場合
  if (partType === '板金') {
    const volume = dimensions.length! * dimensions.width! * dimensions.thickness! / 1000000; // m³
    const density = getMaterialDensity(material); // kg/m³
    return volume * density;
  }
  // その他のPart Typeの計算ロジック
  return 0;
}
```

---

## 11. 出力処理設計

### 11.1 PDF出力

```typescript
// lib/export/pdfExporter.ts

interface ExportData {
  projectInfo: ProjectInfo;
  tableData: EstimateTableRow[];
  costCalculation: CostCalculation;
  remarksData: RemarksData;
  approvalInfo: ApprovalInfo;
}

async function exportToPdf(data: ExportData): Promise<void> {
  // 1. jsPDFインスタンス作成
  // 2. ヘッダー情報を追加
  // 3. 基本情報を追加
  // 4. 原価明細テーブルを追加
  // 5. 原価計算結果を追加
  // 6. 備考・補足を追加
  // 7. 査印欄を追加
  // 8. PDFファイルをダウンロード
}
```

### 11.2 Excel出力

```typescript
// lib/export/excelExporter.ts

async function exportToExcel(data: ExportData): Promise<void> {
  // 1. ExcelJSワークブック作成
  // 2. シート作成
  // 3. ヘッダー情報を追加
  // 4. 基本情報を追加
  // 5. 原価明細テーブルを追加
  // 6. 原価計算結果を追加
  // 7. 備考・補足を追加
  // 8. 査印欄を追加
  // 9. Excelファイルをダウンロード
}
```

---

## 12. ストレージ設計

### 12.1 ローカルストレージ設計

```typescript
// lib/storage/localStorage.ts

// キー設計
const STORAGE_KEYS = {
  ESTIMATES: 'estimates',
  TEMPLATES: 'templates',
  SETTINGS: 'settings'
};

// データ構造
interface StorageData {
  estimates: Estimate[];
  templates: Template[];
  settings: {
    defaultTemplateId?: string;
    autoSave?: boolean;
  };
}
```

### 12.2 IndexedDB設計（オプション）

```typescript
// lib/storage/indexedDB.ts

// データベース設計
const DB_NAME = 'EstimateAppDB';
const DB_VERSION = 1;

// オブジェクトストア
const STORES = {
  ESTIMATES: 'estimates',
  TEMPLATES: 'templates'
};

// インデックス
// estimates: id, estimateNumber, createdAt
// templates: id, name, createdAt
```

---

## 13. バリデーション設計

### 13.1 基本情報バリデーション

```typescript
// lib/validation/projectInfo.ts

import { z } from 'zod';

const projectInfoSchema = z.object({
  estimateNumber: z.string().min(1, '見積番号は必須です'),
  customer: z.string().min(1, '客先は必須です'),
  deliveryDestination: z.string().min(1, '向先は必須です'),
  equipmentName: z.string().min(1, '機器名は必須です'),
  productionQuantity: z.number().positive('製作数量は0より大きい値が必要です'),
  productionUnit: z.enum(['台', '個', '式']),
  deliveryDate: z.date(),
  model: z.string().min(1, '機種は必須です'),
  equipmentShape: z.string().min(1, '機器形状は必須です'),
  weight: z.number().nonnegative('重量は0以上の値が必要です')
});

function validateProjectInfo(info: ProjectInfo): ValidationResult {
  // zodスキーマでバリデーション
  // エラーを返却
}
```

### 13.2 テーブル行バリデーション

```typescript
// lib/validation/tableRow.ts

const tableRowSchema = z.object({
  modelNumber: z.string(),
  name: z.string(),
  material: z.string(),
  quantity: z.number().positive(),
  unitPrice: z.number().nonnegative()
});

function validateTableRow(row: EstimateTableRow): ValidationResult {
  // バリデーション実行
}
```

---

## 14. エラーハンドリング設計

### 14.1 エラー種別

```typescript
enum ErrorType {
  VALIDATION_ERROR = 'VALIDATION_ERROR',
  FILE_ERROR = 'FILE_ERROR',
  PARSE_ERROR = 'PARSE_ERROR',
  CALCULATION_ERROR = 'CALCULATION_ERROR',
  STORAGE_ERROR = 'STORAGE_ERROR',
  EXPORT_ERROR = 'EXPORT_ERROR'
}

interface AppError {
  type: ErrorType;
  message: string;
  details?: any;
}
```

### 14.2 エラーハンドリング戦略

```typescript
// エラーハンドリングユーティリティ

function handleError(error: AppError): void {
  switch (error.type) {
    case ErrorType.VALIDATION_ERROR:
      // バリデーションエラー表示
      showValidationError(error.message);
      break;
    case ErrorType.FILE_ERROR:
      // ファイルエラー表示
      showFileError(error.message);
      break;
    // その他のエラー処理
  }
}
```

---

## 15. セキュリティ設計

### 15.1 入力値サニタイズ

```typescript
// XSS対策
function sanitizeInput(input: string): string {
  // HTMLエスケープ処理
  return input
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#x27;');
}
```

### 15.2 ファイル検証

```typescript
// ファイル検証
function validateFile(file: File): ValidationResult {
  // ファイル形式チェック
  // ファイルサイズチェック
  // ファイル名チェック
}
```

---

## 16. パフォーマンス設計

### 16.1 最適化方針

- **仮想スクロール**: 大量データのテーブル表示時に使用
- **メモ化**: 計算結果のキャッシュ
- **デバウンス**: 入力処理の最適化
- **コード分割**: 動的インポートでバンドルサイズ削減

### 16.2 パフォーマンス目標

- テーブル1000行の表示: 1秒以内
- ファイル解析（10MB）: 30秒以内
- 画面遷移: 1秒以内
- 自動計算: 100ms以内

---

## 17. テスト設計

### 17.1 単体テスト

```typescript
// tests/unit/calculation/materialCost.test.ts

describe('calculateMaterialCost', () => {
  it('should calculate total material cost', () => {
    const tableData = [
      { price: 1000 },
      { price: 2000 },
      { price: 3000 }
    ];
    expect(calculateMaterialCost(tableData)).toBe(6000);
  });
});
```

### 17.2 結合テスト

```typescript
// tests/integration/estimateFlow.test.ts

describe('Estimate Flow', () => {
  it('should create and save estimate', async () => {
    // 見積書作成フローのテスト
  });
});
```

### 17.3 E2Eテスト

```typescript
// tests/e2e/estimate.spec.ts

test('create estimate', async ({ page }) => {
  // 見積書作成のE2Eテスト
});
```

---

## 18. 開発環境設定

### 18.1 環境変数

```env
# .env.local
NEXT_PUBLIC_APP_NAME=見積書デモアプリ
NEXT_PUBLIC_MAX_FILE_SIZE=10485760 # 10MB
```

### 18.2 ビルド設定

```javascript
// next.config.js
module.exports = {
  reactStrictMode: true,
  swcMinify: true,
  // その他の設定
};
```

---

## 19. デプロイ設計

### 19.1 ビルド

```bash
npm run build
```

### 19.2 デプロイ方法

- **静的エクスポート**: `next export`で静的ファイルを生成
- **Vercel**: Next.jsの推奨デプロイ先
- **その他**: Netlify、GitHub Pages等

---

## 20. 今後の拡張性

### 20.1 将来の拡張機能

- サーバーサイドAPI連携
- ユーザー認証機能
- データベース連携
- 複数ユーザー対応
- バージョン管理機能

---

## 21. 参考資料

- Next.js公式ドキュメント
- React公式ドキュメント
- TypeScript公式ドキュメント
- ExcelJS公式ドキュメント
- jsPDF公式ドキュメント

